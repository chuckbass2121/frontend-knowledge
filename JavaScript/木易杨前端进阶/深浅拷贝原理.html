<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>详细解析赋值、浅拷贝和深拷贝的区别 | 前端知识</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="主要记录自己对前端知识的梳理和理解。">
    
    <link rel="preload" href="/frontend-knowledge/assets/css/0.styles.1d57cce0.css" as="style"><link rel="preload" href="/frontend-knowledge/assets/js/app.1cec9800.js" as="script"><link rel="preload" href="/frontend-knowledge/assets/js/2.62f2d1a2.js" as="script"><link rel="preload" href="/frontend-knowledge/assets/js/87.140cbd00.js" as="script"><link rel="prefetch" href="/frontend-knowledge/assets/js/10.cb033405.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/100.1cfff20c.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/101.c97c0c53.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/102.237855a3.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/103.dbdb89f8.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/104.00061043.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/105.a017b90d.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/106.fb789a3f.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/107.b1260f64.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/108.33366212.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/109.fc62621d.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/11.8c9f002b.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/110.fb1d9ac5.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/111.d29372e8.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/112.f1f07bd4.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/113.2c77f34a.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/114.85c7dfa6.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/115.0bdebd25.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/116.c4fe9386.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/117.a61712b5.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/118.0494a6f2.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/119.4f7c25e4.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/12.ba510af0.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/120.dae02a41.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/121.79870164.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/122.797f4971.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/123.f96ce342.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/124.4f98c7a3.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/125.6da5159e.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/126.f3ee9ce4.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/127.70c619d4.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/128.2abac1af.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/129.d07e5ad2.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/13.637e528b.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/130.9106a2d0.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/131.1451a800.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/132.2e916197.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/133.b5553de4.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/134.5318386e.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/135.66095667.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/136.4c05537e.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/137.b6b7dd8b.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/138.74c0af7e.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/139.ac96ae2f.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/14.90b448a1.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/140.53ea5125.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/141.ffdb5f6a.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/142.39ad7c99.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/143.a27f0573.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/144.096c30d2.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/145.ea5e31c1.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/146.8b18bddc.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/147.95977d6c.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/148.b01ff29a.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/149.ace56f69.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/15.77d6091c.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/150.2baf0f19.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/151.82fd6c6d.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/152.fa3693c5.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/153.9f7fed2d.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/154.c5c3e87a.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/155.5a6c76bc.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/156.fdf49347.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/157.20b62dea.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/158.e37460a2.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/159.75796385.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/16.e09fb518.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/160.8bc94acd.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/161.d7e5ae15.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/162.60ed76e1.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/163.8646d8e0.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/164.d4fc32f9.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/165.0cfbe217.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/166.46703943.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/167.c6d029fe.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/168.923268ef.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/169.3c989f4a.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/17.16097bc0.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/170.8c60ad04.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/171.c05ceceb.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/172.f8810bf2.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/173.a53691cd.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/174.3ff02851.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/175.50a74e3a.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/176.61465fb4.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/177.5cd75c2e.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/178.f8fff93e.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/179.8d0e66ff.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/18.72a03825.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/180.89bd8312.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/181.31ae395f.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/182.c27ed932.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/183.dbf6842b.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/184.1715511f.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/185.5b2bdf63.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/186.d41e855e.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/187.def73b08.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/188.81386d52.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/189.cf60dd1b.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/19.168b850f.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/190.9bd39119.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/191.59bf97e9.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/192.edea6b4f.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/193.219d51c9.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/194.412d0b1b.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/195.d3ac99d3.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/196.acf5709e.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/197.c38f3281.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/198.1ed50c4f.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/199.59c4d671.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/20.f3c9ee84.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/200.414c6059.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/201.a3784797.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/202.4f810b3c.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/203.408f92f6.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/204.a1a392a4.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/205.fce0c3f1.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/206.33527f58.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/207.ea6e0171.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/208.4d3e0b4c.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/209.d2c41966.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/21.ca8fbfb4.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/210.d4395409.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/211.b296df72.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/212.a83461de.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/213.f1bc16b0.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/214.d8d6938f.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/215.395b8a63.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/216.82888203.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/217.179c368f.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/218.83d414e7.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/219.cbceaf29.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/22.f6ef8b1a.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/220.ed3e0796.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/221.ab8a62a7.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/222.1c7b49a4.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/223.c096efe5.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/224.3e09f9eb.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/225.3fd70805.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/226.ec7508c0.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/227.637f1b97.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/228.59312113.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/229.c7f07759.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/23.29283229.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/230.e6020f41.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/231.c77ba663.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/232.4bb02977.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/233.665eb219.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/234.c5067b90.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/235.c75d0784.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/236.1be515ac.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/237.3d43316e.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/238.6133fc57.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/239.a9371c48.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/24.cb3dc1d7.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/240.b5776c7d.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/241.981927fa.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/242.20ba7daa.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/243.42989149.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/244.a4570442.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/245.47c0e154.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/246.82aaff0e.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/247.1ba5f6e2.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/248.6753411f.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/249.994b9a6f.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/25.557f489f.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/250.da5b251a.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/251.a294cd86.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/252.cdf046f6.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/253.3f9b31a5.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/254.edfcddbf.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/255.0128a2a0.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/256.962d475b.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/257.499baef8.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/258.102ed941.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/259.5f0a92a0.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/26.3f3fe69b.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/260.0a16e6a4.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/261.1cde38ed.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/262.41c5402f.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/263.4731e25c.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/264.cf1fe0df.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/265.09c6ac75.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/266.fce79351.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/267.69157382.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/268.e4bb0bd9.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/269.3858d043.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/27.bcbf82e8.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/270.cfe1dcff.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/271.e995a15a.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/272.cb3d6d20.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/273.343cc22e.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/274.b17cf9ba.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/275.487cedd6.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/276.cbfa007d.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/277.63122c08.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/278.9afccf40.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/279.db8bf846.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/28.5fdfdb80.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/280.da0754b0.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/281.45df2da6.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/282.7b1eca6c.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/283.b1f352e4.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/284.37935505.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/285.3bfd697e.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/286.3a414954.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/287.68a6dd0a.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/288.9a47aa20.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/289.b8ce07f4.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/29.b3396301.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/290.768317ef.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/291.77bd7840.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/292.03c83bde.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/293.1aec6f12.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/294.cc368294.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/295.dce0a4d8.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/296.62a37217.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/297.e28c003a.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/298.e5f07135.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/299.3672ed89.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/3.e514da99.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/30.52b3e8ca.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/300.62cf5c02.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/301.1a88fc63.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/302.ce627bbb.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/303.f1d2d6e0.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/304.6118b9d9.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/305.a0a24fc1.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/306.e7ba31fa.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/307.0eda022d.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/308.93fbfeb0.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/309.0555823d.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/31.20c853ca.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/310.06f1f230.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/311.4d7c1965.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/312.5e59a6b3.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/313.91d3df87.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/314.f75563fd.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/315.1b46bfc9.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/316.1867c5b2.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/317.5d683392.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/318.d1d9d294.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/319.02661749.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/32.df94b6c0.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/320.25cf59ef.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/321.22403905.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/322.2a3d4201.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/323.aa2da01e.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/324.b3c44f88.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/325.44895731.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/326.b6ffafb2.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/327.db274c55.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/328.903cf082.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/329.94fbe02d.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/33.5046ef25.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/330.49a1fa5c.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/34.b55746e5.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/35.628c630c.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/36.36029402.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/37.6a6af327.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/38.71ec4eae.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/39.dfe5806e.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/4.80bc7d2f.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/40.af0d3322.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/41.af2f1923.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/42.660e0643.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/43.297c68dc.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/44.86d4c424.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/45.03720ba1.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/46.7fe4fb02.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/47.84a62c3f.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/48.8df2c3da.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/49.77c64bf5.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/5.5b93ae0c.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/50.b7ef823a.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/51.2c9a2a94.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/52.bb65d789.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/53.bafeebdc.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/54.b0abb0ac.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/55.932377b4.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/56.f8bb49eb.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/57.b3f98972.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/58.21e321bd.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/59.419939fc.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/6.5fc845fb.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/60.08d74b08.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/61.da8730c3.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/62.de6e9ccf.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/63.d909565b.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/64.b63aa715.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/65.a703cbf4.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/66.bbec4239.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/67.49af75ab.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/68.73a24712.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/69.3a0bbbb7.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/7.34dc28a0.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/70.6f5e2ccc.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/71.ad8223da.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/72.ea8977cc.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/73.b77b19dd.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/74.10c48b8c.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/75.e46837ec.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/76.7ac7b14e.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/77.2571d098.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/78.422d13be.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/79.3450baad.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/8.8c982acf.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/80.08cef119.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/81.a65707d1.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/82.726f9fa4.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/83.6e9a522d.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/84.2f4e2ac3.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/85.298ebf0a.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/86.d2d96d0c.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/88.3cd8a951.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/89.4122850b.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/9.640b0c71.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/90.e2c4d923.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/91.04ddd332.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/92.f1b75ce7.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/93.e22216da.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/94.3bd3e162.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/95.6159a545.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/96.ec28b8cd.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/97.6f56bda9.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/98.6b40d328.js"><link rel="prefetch" href="/frontend-knowledge/assets/js/99.87f07f04.js">
    <link rel="stylesheet" href="/frontend-knowledge/assets/css/0.styles.1d57cce0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/frontend-knowledge/" class="home-link router-link-active"><!----> <span class="site-name">前端知识</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://github.com/chuckbass2121/frontend-knowledge" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://github.com/chuckbass2121/frontend-knowledge" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>CSS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>JavaScript</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/frontend-knowledge/JavaScript/==vs===vsObject.is().html" class="sidebar-link">==vs===vsObject.is().md</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>DOM</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/frontend-knowledge/JavaScript/ES-Next新特性.html" class="sidebar-link">ES-Next新特性.md</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>ES6</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>EventLoop</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/frontend-knowledge/JavaScript/JS相关.html" class="sidebar-link">JS相关.md</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>JavaScript深入系列</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/frontend-knowledge/JavaScript/V8.html" class="sidebar-link">V8.md</a></li><li><a href="/frontend-knowledge/JavaScript/Worker.html" class="sidebar-link">Worker.md</a></li><li><a href="/frontend-knowledge/JavaScript/一个例子来认识闭包是什么，为什么需要它.html" class="sidebar-link">一个例子来认识闭包是什么，为什么需要它.md</a></li><li><a href="/frontend-knowledge/JavaScript/事件循环.html" class="sidebar-link">事件循环.md</a></li><li><a href="/frontend-knowledge/JavaScript/位运算.html" class="sidebar-link">位运算.md</a></li><li><a href="/frontend-knowledge/JavaScript/全面分析toString和valueOf.html" class="sidebar-link">全面分析toString和valueOf.md</a></li><li><a href="/frontend-knowledge/JavaScript/动画.html" class="sidebar-link">动画.md</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>基础</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/frontend-knowledge/JavaScript/执行上下文.html" class="sidebar-link">执行上下文.md</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>木易杨前端进阶</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/frontend-knowledge/JavaScript/木易杨前端进阶/this 全面解析.html" class="sidebar-link">this 全面解析.md</a></li><li><a href="/frontend-knowledge/JavaScript/木易杨前端进阶/作用域闭包.html" class="sidebar-link">作用域闭包.md</a></li><li><a href="/frontend-knowledge/JavaScript/木易杨前端进阶/深浅拷贝原理.html" class="active sidebar-link">深浅拷贝原理.md</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/frontend-knowledge/JavaScript/木易杨前端进阶/深浅拷贝原理.html#赋值-copy" class="sidebar-link">赋值（Copy）</a></li><li class="sidebar-sub-header"><a href="/frontend-knowledge/JavaScript/木易杨前端进阶/深浅拷贝原理.html#浅拷贝-shallow-copy" class="sidebar-link">浅拷贝（Shallow Copy）</a></li><li class="sidebar-sub-header"><a href="/frontend-knowledge/JavaScript/木易杨前端进阶/深浅拷贝原理.html#深拷贝-deep-copy" class="sidebar-link">深拷贝（Deep Copy）</a></li><li class="sidebar-sub-header"><a href="/frontend-knowledge/JavaScript/木易杨前端进阶/深浅拷贝原理.html#总结" class="sidebar-link">总结</a></li><li class="sidebar-sub-header"><a href="/frontend-knowledge/JavaScript/木易杨前端进阶/深浅拷贝原理.html#模拟实现" class="sidebar-link">模拟实现</a></li><li class="sidebar-sub-header"><a href="/frontend-knowledge/JavaScript/木易杨前端进阶/深浅拷贝原理.html#注意点" class="sidebar-link">注意点</a></li><li class="sidebar-sub-header"><a href="/frontend-knowledge/JavaScript/木易杨前端进阶/深浅拷贝原理.html#简单实现" class="sidebar-link">简单实现</a></li><li class="sidebar-sub-header"><a href="/frontend-knowledge/JavaScript/木易杨前端进阶/深浅拷贝原理.html#拷贝数组" class="sidebar-link">拷贝数组</a></li><li class="sidebar-sub-header"><a href="/frontend-knowledge/JavaScript/木易杨前端进阶/深浅拷贝原理.html#循环引用" class="sidebar-link">循环引用</a></li><li class="sidebar-sub-header"><a href="/frontend-knowledge/JavaScript/木易杨前端进阶/深浅拷贝原理.html#拷贝-symbol" class="sidebar-link">拷贝 Symbol</a></li><li class="sidebar-sub-header"><a href="/frontend-knowledge/JavaScript/木易杨前端进阶/深浅拷贝原理.html#破解递归爆栈" class="sidebar-link">破解递归爆栈</a></li><li class="sidebar-sub-header"><a href="/frontend-knowledge/JavaScript/木易杨前端进阶/深浅拷贝原理.html#整体流程" class="sidebar-link">整体流程</a></li><li class="sidebar-sub-header"><a href="/frontend-knowledge/JavaScript/木易杨前端进阶/深浅拷贝原理.html#baseclone-完整代码" class="sidebar-link">baseClone 完整代码</a></li><li class="sidebar-sub-header"><a href="/frontend-knowledge/JavaScript/木易杨前端进阶/深浅拷贝原理.html#详细功能实现" class="sidebar-link">详细功能实现</a></li></ul></li><li><a href="/frontend-knowledge/JavaScript/木易杨前端进阶/调用堆栈.html" class="sidebar-link">调用堆栈.md</a></li></ul></section></li><li><a href="/frontend-knowledge/JavaScript/观察者模式和发布订阅模式的区别.html" class="sidebar-link">观察者模式和发布订阅模式的区别.md</a></li><li><a href="/frontend-knowledge/JavaScript/设计模式.html" class="sidebar-link">设计模式.md</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>NodeJS</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/frontend-knowledge/" aria-current="page" class="sidebar-link">README.md</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>TypeScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Webpack</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>安全</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>实践篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>性能优化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>手写代码</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>框架</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>模块化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>浏览器渲染</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>真题</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>算法</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>网络</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>计算机基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>错误监控</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="详细解析赋值、浅拷贝和深拷贝的区别"><a href="#详细解析赋值、浅拷贝和深拷贝的区别" class="header-anchor">#</a> 详细解析赋值、浅拷贝和深拷贝的区别</h1> <h2 id="赋值-copy"><a href="#赋值-copy" class="header-anchor">#</a> 赋值（Copy）</h2> <p>赋值是将某一数组或对象赋给某个变量的过程，分类下面 2 部分：</p> <ul><li>基本数据类型：赋值，赋值之后两个变量互不影响</li> <li>引用数据类型：<strong>赋址</strong>，两个变量具有相同的引用，指向同一个对象，相互之间有影响</li></ul> <p>对基本类型进行赋值操作，两个变量互不影响。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token string">&quot;muyiy&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> b <span class="token operator">=</span> a<span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// muyiy</span>

a <span class="token operator">=</span> <span class="token string">&quot;change&quot;</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// change</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// muyiy</span>
</code></pre></div><p>对引用类型进行赋<strong>址</strong>操作，两个变量指向同一个对象，改变变量 a 之后会影响变量 b，哪怕改变的只是对象 a 中的基本类型数据。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">&quot;muyiy&quot;</span><span class="token punctuation">,</span>
    book<span class="token operator">:</span> <span class="token punctuation">{</span>
        title<span class="token operator">:</span> <span class="token string">&quot;You Don't Know JS&quot;</span><span class="token punctuation">,</span>
        price<span class="token operator">:</span> <span class="token string">&quot;45&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> b <span class="token operator">=</span> a<span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// {</span>
<span class="token comment">// 	name: &quot;muyiy&quot;,</span>
<span class="token comment">// 	book: {title: &quot;You Don't Know JS&quot;, price: &quot;45&quot;}</span>
<span class="token comment">// } </span>

a<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;change&quot;</span><span class="token punctuation">;</span>
a<span class="token punctuation">.</span>book<span class="token punctuation">.</span>price <span class="token operator">=</span> <span class="token string">&quot;55&quot;</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// {</span>
<span class="token comment">// 	name: &quot;change&quot;,</span>
<span class="token comment">// 	book: {title: &quot;You Don't Know JS&quot;, price: &quot;55&quot;}</span>
<span class="token comment">// } </span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// {</span>
<span class="token comment">// 	name: &quot;change&quot;,</span>
<span class="token comment">// 	book: {title: &quot;You Don't Know JS&quot;, price: &quot;55&quot;}</span>
<span class="token comment">// } </span>
</code></pre></div><p>通常在开发中并不希望改变变量 a 之后会影响到变量 b，这时就需要用到浅拷贝和深拷贝。</p> <h2 id="浅拷贝-shallow-copy"><a href="#浅拷贝-shallow-copy" class="header-anchor">#</a> 浅拷贝（Shallow Copy）</h2> <h3 id="概念"><a href="#概念" class="header-anchor">#</a> 概念</h3> <p>创建一个新对象，这个对象有着原始对象属性值的一份精确拷贝。如果属性是基本类型，拷贝的就是基本类型的值，如果属性是引用类型，拷贝的就是内存地址，所以如果其中一个对象改变了这个地址，就会影响到另一个对象。</p> <p><img src="http://resource.muyiy.cn/image/2019-07-24-060221.png" alt="img"></p> <p>上图中，SourceObject 是原对象，其中包含基本类型属性 field1 和引用类型属性 refObj。浅拷贝之后基本类型数据 field2 和 fileld1 是不同属性，互不影响。但引用类型 refObj 仍然是同一个，改变之后会对另一个对象产生影响。</p> <p>简单来说可以理解为浅拷贝只解决了第一层的问题，拷贝第一层的 <strong>基本类型值</strong>，以及第一层的 <strong>引用类型地址</strong>。</p> <h3 id="使用场景"><a href="#使用场景" class="header-anchor">#</a> 使用场景</h3> <h4 id="object-assign"><a href="#object-assign" class="header-anchor">#</a> <code>Object.assign()</code></h4> <p><code>Object.assign()</code> 方法用于将所有可枚举属性的值从一个或多个源对象复制到目标对象，它将返回目标对象。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">&quot;muyiy&quot;</span><span class="token punctuation">,</span>
    book<span class="token operator">:</span> <span class="token punctuation">{</span>
        title<span class="token operator">:</span> <span class="token string">&quot;You Don't Know JS&quot;</span><span class="token punctuation">,</span>
        price<span class="token operator">:</span> <span class="token string">&quot;45&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> b <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// {</span>
<span class="token comment">// 	name: &quot;muyiy&quot;,</span>
<span class="token comment">// 	book: {title: &quot;You Don't Know JS&quot;, price: &quot;45&quot;}</span>
<span class="token comment">// } </span>

a<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;change&quot;</span><span class="token punctuation">;</span>
a<span class="token punctuation">.</span>book<span class="token punctuation">.</span>price <span class="token operator">=</span> <span class="token string">&quot;55&quot;</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// {</span>
<span class="token comment">// 	name: &quot;change&quot;,</span>
<span class="token comment">// 	book: {title: &quot;You Don't Know JS&quot;, price: &quot;55&quot;}</span>
<span class="token comment">// } </span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// {</span>
<span class="token comment">// 	name: &quot;muyiy&quot;,</span>
<span class="token comment">// 	book: {title: &quot;You Don't Know JS&quot;, price: &quot;55&quot;}</span>
<span class="token comment">// } </span>
</code></pre></div><p>上面代码改变对象 a 之后，对象 b 的基本属性保持不变。但是当改变对象 a 中的对象 <code>book</code> 时，对象 b 相应的位置也发生了变化。</p> <h4 id="展开语法-spread"><a href="#展开语法-spread" class="header-anchor">#</a> 展开语法 Spread</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">&quot;muyiy&quot;</span><span class="token punctuation">,</span>
    book<span class="token operator">:</span> <span class="token punctuation">{</span>
        title<span class="token operator">:</span> <span class="token string">&quot;You Don't Know JS&quot;</span><span class="token punctuation">,</span>
        price<span class="token operator">:</span> <span class="token string">&quot;45&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">...</span>a<span class="token punctuation">}</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// {</span>
<span class="token comment">// 	name: &quot;muyiy&quot;,</span>
<span class="token comment">// 	book: {title: &quot;You Don't Know JS&quot;, price: &quot;45&quot;}</span>
<span class="token comment">// } </span>

a<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;change&quot;</span><span class="token punctuation">;</span>
a<span class="token punctuation">.</span>book<span class="token punctuation">.</span>price <span class="token operator">=</span> <span class="token string">&quot;55&quot;</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// {</span>
<span class="token comment">// 	name: &quot;change&quot;,</span>
<span class="token comment">// 	book: {title: &quot;You Don't Know JS&quot;, price: &quot;55&quot;}</span>
<span class="token comment">// } </span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// {</span>
<span class="token comment">// 	name: &quot;muyiy&quot;,</span>
<span class="token comment">// 	book: {title: &quot;You Don't Know JS&quot;, price: &quot;55&quot;}</span>
<span class="token comment">// } </span>
</code></pre></div><p>通过代码可以看出实际效果和 <code>Object.assign()</code> 是一样的。</p> <h4 id="array-prototype-slice"><a href="#array-prototype-slice" class="header-anchor">#</a> <code>Array.prototype.slice()</code></h4> <p><code>slice()</code> 方法返回一个新的数组对象，这一对象是一个由 <code>begin</code>和 <code>end</code>（不包括<code>end</code>）决定的原数组的<strong>浅拷贝</strong>。原始数组不会被改变。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> b <span class="token operator">=</span> a<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// [&quot;1&quot;, [2, 3]]</span>

a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;99&quot;</span><span class="token punctuation">;</span>
a<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// [0, &quot;99&quot;, [4, 3]]</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//  [&quot;1&quot;, [4, 3]]</span>
</code></pre></div><p>可以看出，改变 <code>a[1]</code> 之后 <code>b[0]</code> 的值并没有发生变化，但改变 <code>a[2][0]</code> 之后，相应的 <code>b[1][0]</code> 的值也发生变化。说明 <code>slice()</code> 方法是浅拷贝，相应的还有<code>concat</code>等，在工作中面对复杂数组结构要额外注意。</p> <h2 id="深拷贝-deep-copy"><a href="#深拷贝-deep-copy" class="header-anchor">#</a> 深拷贝（Deep Copy）</h2> <h3 id="概念-2"><a href="#概念-2" class="header-anchor">#</a> 概念</h3> <p>深拷贝会拷贝所有的属性，并拷贝属性指向的动态分配的内存。当对象和它所引用的对象一起拷贝时即发生深拷贝。深拷贝相比于浅拷贝速度较慢并且花销较大。拷贝前后两个对象互不影响。</p> <p><img src="http://resource.muyiy.cn/image/2019-07-24-060222.png" alt="img"></p> <h3 id="使用场景-2"><a href="#使用场景-2" class="header-anchor">#</a> 使用场景</h3> <h4 id="json-parse-json-stringify-object"><a href="#json-parse-json-stringify-object" class="header-anchor">#</a> <code>JSON.parse(JSON.stringify(object))</code></h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">&quot;muyiy&quot;</span><span class="token punctuation">,</span>
    book<span class="token operator">:</span> <span class="token punctuation">{</span>
        title<span class="token operator">:</span> <span class="token string">&quot;You Don't Know JS&quot;</span><span class="token punctuation">,</span>
        price<span class="token operator">:</span> <span class="token string">&quot;45&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// {</span>
<span class="token comment">// 	name: &quot;muyiy&quot;,</span>
<span class="token comment">// 	book: {title: &quot;You Don't Know JS&quot;, price: &quot;45&quot;}</span>
<span class="token comment">// } </span>

a<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;change&quot;</span><span class="token punctuation">;</span>
a<span class="token punctuation">.</span>book<span class="token punctuation">.</span>price <span class="token operator">=</span> <span class="token string">&quot;55&quot;</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// {</span>
<span class="token comment">// 	name: &quot;change&quot;,</span>
<span class="token comment">// 	book: {title: &quot;You Don't Know JS&quot;, price: &quot;55&quot;}</span>
<span class="token comment">// } </span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// {</span>
<span class="token comment">// 	name: &quot;muyiy&quot;,</span>
<span class="token comment">// 	book: {title: &quot;You Don't Know JS&quot;, price: &quot;45&quot;}</span>
<span class="token comment">// } </span>
</code></pre></div><p>完全改变变量 a 之后对 b 没有任何影响，这就是深拷贝的魔力。</p> <p>我们看下对数组深拷贝效果如何。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span> a<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// [&quot;1&quot;, [2, 3]]</span>

a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;99&quot;</span><span class="token punctuation">;</span>
a<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// [0, &quot;99&quot;, [4, 3]]</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//  [&quot;1&quot;, [2, 3]]</span>
</code></pre></div><p>对数组深拷贝之后，改变原数组不会影响到拷贝之后的数组。</p> <p><strong>但是 <code>JSON.parse(JSON.stringify(object))</code> 仍然有缺陷</strong></p> <ul><li>会忽略 undefined</li> <li>会忽略 symbol</li> <li>不能序列化函数</li> <li>不能解决循环引用的对象</li> <li>不能正确处理 <code>new Date()</code></li> <li>不能处理正则</li></ul> <h5 id="undefined、symbol-和函数这三种情况-会直接忽略"><a href="#undefined、symbol-和函数这三种情况-会直接忽略" class="header-anchor">#</a> undefined、symbol 和函数这三种情况，会直接忽略</h5> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'muyiy'</span><span class="token punctuation">,</span>
    a<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
    b<span class="token operator">:</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">'muyiy'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function-variable function">c</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// {</span>
<span class="token comment">// 	name: &quot;muyiy&quot;, </span>
<span class="token comment">// 	a: undefined, </span>
<span class="token comment">//  b: Symbol(muyiy), </span>
<span class="token comment">//  c: ƒ ()</span>
<span class="token comment">// }</span>

<span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// {name: &quot;muyiy&quot;}</span>
</code></pre></div><h5 id="循环引用情况下-会报错"><a href="#循环引用情况下-会报错" class="header-anchor">#</a> 循环引用情况下，会报错</h5> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
    a<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    b<span class="token operator">:</span> <span class="token punctuation">{</span>
        c<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
   		d<span class="token operator">:</span> <span class="token number">3</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
obj<span class="token punctuation">.</span>a <span class="token operator">=</span> obj<span class="token punctuation">.</span>b<span class="token punctuation">;</span>
obj<span class="token punctuation">.</span>b<span class="token punctuation">.</span>c <span class="token operator">=</span> obj<span class="token punctuation">.</span>a<span class="token punctuation">;</span>

<span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Uncaught TypeError: Converting circular structure to JSON</span>
</code></pre></div><h5 id="new-date-情况下-转换结果不正确"><a href="#new-date-情况下-转换结果不正确" class="header-anchor">#</a> <code>new Date</code> 情况下，转换结果不正确</h5> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Mon Dec 24 2018 10:59:14 GMT+0800 (China Standard Time)</span>

<span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// &quot;&quot;2018-12-24T02:59:25.776Z&quot;&quot;</span>

<span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// &quot;2018-12-24T02:59:41.523Z&quot;</span>
</code></pre></div><p>解决方法转成字符串或者时间戳就好了。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token keyword">let</span> date <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 1545620645915</span>

<span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// &quot;1545620673267&quot;</span>

<span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 1545620658688</span>
</code></pre></div><h5 id="正则会变成空对象"><a href="#正则会变成空对象" class="header-anchor">#</a> 正则会变成空对象</h5> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">&quot;muyiy&quot;</span><span class="token punctuation">,</span>
    a<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">'123'</span><span class="token regex-delimiter">/</span></span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// {name: &quot;muyiy&quot;, a: /'123'/}</span>

<span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// {name: &quot;muyiy&quot;, a: {}}</span>
</code></pre></div><h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <table><thead><tr><th style="text-align:center;">--</th> <th style="text-align:center;">和原数据是否指向同一对象</th> <th style="text-align:center;">第一层数据为基本数据类型</th> <th style="text-align:center;">原数据中包含子对象</th></tr></thead> <tbody><tr><td style="text-align:center;">赋值</td> <td style="text-align:center;">是</td> <td style="text-align:center;">改变会使原数据一同改变</td> <td style="text-align:center;">改变会使原数据一同改变</td></tr> <tr><td style="text-align:center;">浅拷贝</td> <td style="text-align:center;">否</td> <td style="text-align:center;">改变<strong>不</strong>会使原数据一同改变</td> <td style="text-align:center;">改变会使原数据一同改变</td></tr> <tr><td style="text-align:center;">深拷贝</td> <td style="text-align:center;">否</td> <td style="text-align:center;">改变<strong>不</strong>会使原数据一同改变</td> <td style="text-align:center;">改变<strong>不</strong>会使原数据一同改变</td></tr></tbody></table> <h1 id="object-assign-原理及其实现"><a href="#object-assign-原理及其实现" class="header-anchor">#</a> <code>Object.assign</code> 原理及其实现</h1> <p><code>Object.assign</code> 主要是将所有 <strong>可枚举属性</strong> 的值从一个或多个源对象赋值到目标对象，同时返回目标对象。</p> <p>如果目标对象中的属性具有相同的键，则属性将被源对象中的属性覆盖。后来的源对象属性将类似的覆盖早先的属性。</p> <h2 id="模拟实现"><a href="#模拟实现" class="header-anchor">#</a> 模拟实现</h2> <p>实现一个 <code>Object.assign</code> 的大致思路如下：</p> <ol><li>判断 Object 是否支持该函数，如果不存在的话创建一个函数 <code>assign</code> ，并使用 <code>Object.defineProperty</code> 将该函数绑定到 Object 上；</li> <li>判断参数是否正确（目标对象不能为空，我们可以直接设置 <code>{}</code> 传递进去，但必须设置值）；</li> <li>使用 <code>Object()</code> 转成对象，并保存为 to，最后返回这个对象 to；</li> <li>使用 <code>for...in</code> 循环遍历出所有可枚举的自有属性，并复制给新的目标对象（使用 <code>hasOwnProperty</code> 获取自有属性，即非原型链上的属性）。</li></ol> <p><strong>注意⚠️：此模拟不支持 symbol，因为 ES5 中没有 symbol。</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> Object<span class="token punctuation">.</span>assign <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Attention 1</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Object<span class="token punctuation">,</span> <span class="token string">'assign'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">value</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token string">'use strict'</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>target <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Attention 2</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'Cannot convert undefined of null to object'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      
      <span class="token comment">// Attention 3</span>
      <span class="token keyword">var</span> to <span class="token operator">=</span> <span class="token function">Object</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
      
      <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> index <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> index <span class="token operator">&lt;</span> arguments<span class="token punctuation">.</span>length<span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> nextSource <span class="token operator">=</span> arguments<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
        
        <span class="token keyword">if</span><span class="token punctuation">(</span>nextSource <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Attention 2</span>
          <span class="token comment">// Attention 4</span>
          <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> nextKey <span class="token keyword">in</span> nextSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>nextSource<span class="token punctuation">,</span> nextKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              to<span class="token punctuation">[</span>nextKey<span class="token punctuation">]</span> <span class="token operator">=</span> nextSource<span class="token punctuation">[</span>nextKey<span class="token punctuation">]</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      
      <span class="token keyword">return</span> to
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    writable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    configurable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    enumerable<span class="token operator">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="注意点"><a href="#注意点" class="header-anchor">#</a> 注意点</h2> <h3 id="可枚举性"><a href="#可枚举性" class="header-anchor">#</a> 可枚举性</h3> <p>我们查看查看原生的 <code>Object.assign</code> ，发现它是不可枚举的。</p> <div class="language-js extra-class"><pre class="language-js"><code>Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span>Object<span class="token punctuation">,</span> <span class="token string">&quot;assign&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// {</span>
<span class="token comment">// 	value: ƒ, </span>
<span class="token comment">//  writable: true, 	// 可写</span>
<span class="token comment">//  enumerable: false,  // 不可枚举，注意这里是 false</span>
<span class="token comment">//  configurable: true	// 可配置</span>
<span class="token comment">// }</span>
</code></pre></div><p>因此，在使用 <code>Object.defineProperty</code> 定义的时候，需要将 enumerable 设置为 false。</p> <h3 id="判断参数是否正确"><a href="#判断参数是否正确" class="header-anchor">#</a> 判断参数是否正确</h3> <p>有些文章判断参数是否正确是这样的。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">||</span> target <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'Cannot convert undefined or null to object'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这样肯定没问题，但是这样写没有必要，因为 <code>undefined</code> 和 <code>null</code> 是相等的（高程 3 P52 ），即 <code>undefined == null</code> 返回 <code>true</code>，只需要按照如下方式判断就好了。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// TypeError if undefined or null</span>
	<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'Cannot convert undefined or null to object'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="原始类型被包装为对象"><a href="#原始类型被包装为对象" class="header-anchor">#</a> 原始类型被包装为对象</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token keyword">var</span> v1 <span class="token operator">=</span> <span class="token string">&quot;abc&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> v2 <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> v3 <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> v4 <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> obj <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> v1<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> v2<span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> v3<span class="token punctuation">,</span> v4<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">// 原始类型会被包装，null 和 undefined 会被忽略。</span>
<span class="token comment">// 注意，只有字符串的包装对象才可能有自身可枚举属性。</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">// { &quot;0&quot;: &quot;a&quot;, &quot;1&quot;: &quot;b&quot;, &quot;2&quot;: &quot;c&quot; }</span>
</code></pre></div><p>上面代码中的源对象 v2、v3、v4 实际上被忽略了，原因在于他们自身<strong>没有可枚举属性</strong>。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token keyword">var</span> v1 <span class="token operator">=</span> <span class="token string">&quot;abc&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> v2 <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> v3 <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> v4 <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> v5 <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token comment">// Object.keys(..) 返回一个数组，包含所有可枚举属性</span>
<span class="token comment">// 只会查找对象直接包含的属性，不查找[[Prototype]]链</span>
Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span> v1 <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [ '0', '1', '2' ]</span>
Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span> v2 <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// []</span>
Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span> v3 <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// []</span>
Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span> v4 <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// []</span>
Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span> v5 <span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">// TypeError: Cannot convert undefined or null to object</span>

<span class="token comment">// Object.getOwnPropertyNames(..) 返回一个数组，包含所有属性，无论它们是否可枚举</span>
<span class="token comment">// 只会查找对象直接包含的属性，不查找[[Prototype]]链</span>
Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyNames</span><span class="token punctuation">(</span> v1 <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [ '0', '1', '2', 'length' ]</span>
Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyNames</span><span class="token punctuation">(</span> v2 <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// []</span>
Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyNames</span><span class="token punctuation">(</span> v3 <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// []</span>
Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyNames</span><span class="token punctuation">(</span> v4 <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// []</span>
Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyNames</span><span class="token punctuation">(</span> v5 <span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">// TypeError: Cannot convert undefined or null to object</span>
</code></pre></div><p>但是下面的代码是可以执行的。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token string">&quot;abc&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token punctuation">{</span>
    v1<span class="token operator">:</span> <span class="token string">&quot;def&quot;</span><span class="token punctuation">,</span>
    v2<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    v3<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
    v4<span class="token operator">:</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    v5<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    v6<span class="token operator">:</span> <span class="token keyword">undefined</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> obj <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span> 
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// { </span>
<span class="token comment">//   [String: 'abc']</span>
<span class="token comment">//   v1: 'def',</span>
<span class="token comment">//   v2: true,</span>
<span class="token comment">//   v3: 10,</span>
<span class="token comment">//   v4: Symbol(foo),</span>
<span class="token comment">//   v5: null,</span>
<span class="token comment">//   v6: undefined </span>
<span class="token comment">// }</span>
</code></pre></div><p>原因很简单，因为此时 <code>undefined</code>、<code>true</code> 等不是作为对象，而是作为对象 b 的属性值，对象 b 是可枚举的。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token comment">// 接上面的代码</span>
Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span> b <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [ 'v1', 'v2', 'v3', 'v4', 'v5', 'v6' ]</span>
</code></pre></div><p>这里其实又可以看出一个问题来，那就是目标对象是原始类型，会包装成对象，对应上面的代码就是目标对象 a 会被包装成 <code>[String: 'abc']</code>，那模拟实现时应该如何处理呢？很简单，使用 <code>Object(..)</code> 就可以了。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token string">&quot;abc&quot;</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token function">Object</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// [String: 'abc']</span>
</code></pre></div><p>到这里已经介绍很多知识了，让我们再来延伸一下，看看下面的代码能不能执行。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token string">&quot;abc&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token string">&quot;def&quot;</span><span class="token punctuation">;</span>
Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre></div><p>答案是否定的，会提示以下错误。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
TypeError<span class="token operator">:</span> Cannot assign to read only property <span class="token string">'0'</span> <span class="token keyword">of</span> object <span class="token string">'[object String]'</span>
</code></pre></div><p>原因在于 <code>Object(&quot;abc&quot;)</code> 时，其属性描述符为不可写，即 <code>writable: false</code>。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token keyword">var</span> myObject <span class="token operator">=</span> <span class="token function">Object</span><span class="token punctuation">(</span> <span class="token string">&quot;abc&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyNames</span><span class="token punctuation">(</span> myObject <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// [ '0', '1', '2', 'length' ]</span>

Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span>myObject<span class="token punctuation">,</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// { </span>
<span class="token comment">//   value: 'a',</span>
<span class="token comment">//   writable: false, // 注意这里</span>
<span class="token comment">//   enumerable: true,</span>
<span class="token comment">//   configurable: false </span>
<span class="token comment">// }</span>
</code></pre></div><p>同理，下面的代码也会报错。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token string">&quot;abc&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token number">0</span><span class="token operator">:</span> <span class="token string">&quot;d&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">// TypeError: Cannot assign to read only property '0' of object '[object String]'</span>
</code></pre></div><p>但是并不是说只要 <code>writable: false</code> 就会报错，看下面的代码。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token keyword">var</span> myObject <span class="token operator">=</span> <span class="token function">Object</span><span class="token punctuation">(</span><span class="token string">'abc'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span>myObject<span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// { </span>
<span class="token comment">//   value: 'a',</span>
<span class="token comment">//   writable: false, // 注意这里</span>
<span class="token comment">//   enumerable: true,</span>
<span class="token comment">//   configurable: false </span>
<span class="token comment">// }</span>

myObject<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'d'</span><span class="token punctuation">;</span>
<span class="token comment">// 'd'</span>

myObject<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// 'a'</span>
</code></pre></div><p>这里并没有报错，原因在于 JS 对于不可写的属性值的修改静默失败（silently failed）,在严格模式下才会提示错误。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token string">'use strict'</span>
<span class="token keyword">var</span> myObject <span class="token operator">=</span> <span class="token function">Object</span><span class="token punctuation">(</span><span class="token string">'abc'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

myObject<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'d'</span><span class="token punctuation">;</span>
<span class="token comment">// TypeError: Cannot assign to read only property '0' of object '[object String]'</span>
</code></pre></div><p>所以我们在模拟实现 <code>Object.assign</code> 时需要使用严格模式。</p> <h3 id="存在性"><a href="#存在性" class="header-anchor">#</a> 存在性</h3> <p>如何在不访问属性值的情况下判断对象中是否存在某个属性呢，看下面的代码。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token keyword">var</span> anotherObject <span class="token operator">=</span> <span class="token punctuation">{</span>
    a<span class="token operator">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 创建一个关联到 anotherObject 的对象</span>
<span class="token keyword">var</span> myObject <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span> anotherObject <span class="token punctuation">)</span><span class="token punctuation">;</span>
myObject<span class="token punctuation">.</span>b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

<span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span> <span class="token keyword">in</span> myObject<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
<span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span> <span class="token keyword">in</span> myObject<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>

myObject<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span> <span class="token string">&quot;a&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false</span>
myObject<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span> <span class="token string">&quot;b&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
</code></pre></div><p>这边使用了 <code>in</code> 操作符和 <code>hasOwnProperty</code> 方法，区别如下（你不知道的JS上卷 P119）：</p> <p>1、<code>in</code> 操作符会检查属性是否在对象及其 <code>[[Prototype]]</code> 原型链中。</p> <p>2、<code>hasOwnProperty(..)</code> 只会检查属性是否在 <code>myObject</code> 对象中，不会检查 <code>[[Prototype]]</code> 原型链。</p> <p><code>Object.assign</code> 方法肯定不会拷贝原型链上的属性，所以模拟实现时需要用 <code>hasOwnProperty(..)</code> 判断处理下，但是直接使用 <code>myObject.hasOwnProperty(..)</code> 是有问题的，因为有的对象可能没有连接到 <code>Object.prototype</code> 上（比如通过 <code>Object.create(null)</code> 来创建），这种情况下，使用 <code>myObject.hasOwnProperty(..)</code> 就会失败。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token keyword">var</span> myObject <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span> <span class="token keyword">null</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
myObject<span class="token punctuation">.</span>b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

<span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span> <span class="token keyword">in</span> myObject<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">// true</span>

myObject<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span> <span class="token string">&quot;b&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// TypeError: myObject.hasOwnProperty is not a function</span>
</code></pre></div><p>解决方法也很简单，使用我们在【进阶3-3期】中介绍的 <code>call</code> 就可以了，使用如下。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token keyword">var</span> myObject <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span> <span class="token keyword">null</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
myObject<span class="token punctuation">.</span>b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

<span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>myObject<span class="token punctuation">,</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// true</span>
</code></pre></div><p>所以具体到本次模拟实现中，相关代码如下。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token comment">// 使用 for..in 遍历对象 nextSource 获取属性值</span>
<span class="token comment">// 此处会同时检查其原型链上的属性</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> nextKey <span class="token keyword">in</span> nextSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 使用 hasOwnProperty 判断对象 nextSource 中是否存在属性 nextKey</span>
    <span class="token comment">// 过滤其原型链上的属性</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>nextSource<span class="token punctuation">,</span> nextKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 赋值给对象 to,并在遍历结束后返回对象 to</span>
        to<span class="token punctuation">[</span>nextKey<span class="token punctuation">]</span> <span class="token operator">=</span> nextSource<span class="token punctuation">[</span>nextKey<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h1 id="面试题之如何实现一个深拷贝"><a href="#面试题之如何实现一个深拷贝" class="header-anchor">#</a> 面试题之如何实现一个深拷贝</h1> <p>本文会详细介绍对象、数组、循环引用、引用丢失、Symbol 和递归爆栈等情况下的深拷贝实践。</p> <h2 id="简单实现"><a href="#简单实现" class="header-anchor">#</a> 简单实现</h2> <p>深拷贝可以分为两步：递归 + 浅拷贝，浅拷贝时判断属性值是否是对象，如果是对象就进行递归操作，两者结合就实现了深拷贝。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token keyword">function</span> <span class="token function">cloneShallow</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> target <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> key <span class="token keyword">in</span> source<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> source<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> target<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 测试用例</span>
<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">&quot;muyiy&quot;</span><span class="token punctuation">,</span>
    book<span class="token operator">:</span> <span class="token punctuation">{</span>
        title<span class="token operator">:</span> <span class="token string">&quot;You Don't Know JS&quot;</span><span class="token punctuation">,</span>
        price<span class="token operator">:</span> <span class="token string">&quot;45&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    a1<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
    a2<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    a3<span class="token operator">:</span> <span class="token number">123</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token function">cloneShallow</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>

a<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;高级前端进阶&quot;</span><span class="token punctuation">;</span>
a<span class="token punctuation">.</span>book<span class="token punctuation">.</span>price <span class="token operator">=</span> <span class="token string">&quot;55&quot;</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// { </span>
<span class="token comment">//   name: 'muyiy', </span>
<span class="token comment">//   book: { title: 'You Don\'t Know JS', price: '55' },</span>
<span class="token comment">//   a1: undefined,</span>
<span class="token comment">//   a2: null,</span>
<span class="token comment">//   a3: 123</span>
<span class="token comment">// }</span>
</code></pre></div><p>上面代码是浅拷贝实现，只要稍微改动下，加上是否是对象的判断并在相应的位置使用递归就可以实现简单深拷贝。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token keyword">function</span> <span class="token function">cloneDeep1</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> target <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> key <span class="token keyword">in</span> source<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> source<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">cloneDeep1</span><span class="token punctuation">(</span>source<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 注意这里</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> source<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> target<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 使用上面测试用例测试一下</span>
<span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token function">cloneDeep1</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// { </span>
<span class="token comment">//   name: 'muyiy', </span>
<span class="token comment">//   book: { title: 'You Don\'t Know JS', price: '45' }, </span>
<span class="token comment">//   a1: undefined,</span>
<span class="token comment">//   a2: {},</span>
<span class="token comment">//   a3: 123</span>
<span class="token comment">// }</span>
</code></pre></div><p>一个简单的深拷贝就完成了，但是这个实现方式仍然后很多问题：</p> <ol><li>没有对传入参数进行校验，传入 null 时应该返回 null 而不是 <code>{}</code></li> <li>对于对象的判断不严谨，因为 <code>typeof null === 'object'</code></li> <li>没有考虑数组的兼容</li></ol> <h2 id="拷贝数组"><a href="#拷贝数组" class="header-anchor">#</a> 拷贝数组</h2> <p>首先需要进行数据格式的校验，递归操作需要排除非引用类型的 source。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">isObject</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">typeof</span> data <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> data <span class="token operator">!==</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span>
</code></pre></div><p>所以兼容数组的写法如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token keyword">function</span> <span class="token function">cloneDeep2</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isObject</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> source<span class="token punctuation">;</span> <span class="token comment">// 非对象返回自身</span>
      
    <span class="token keyword">var</span> target <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> key <span class="token keyword">in</span> source<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>source<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">cloneDeep2</span><span class="token punctuation">(</span>source<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 注意这里</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> source<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> target<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 使用上面测试用例测试一下</span>
<span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token function">cloneDeep2</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// { </span>
<span class="token comment">//   name: 'muyiy', </span>
<span class="token comment">//   book: { title: 'You Don\'t Know JS', price: '45' },</span>
<span class="token comment">//   a1: undefined,</span>
<span class="token comment">//   a2: null,</span>
<span class="token comment">//   a3: 123</span>
<span class="token comment">// }</span>
</code></pre></div><h2 id="循环引用"><a href="#循环引用" class="header-anchor">#</a> 循环引用</h2> <p>我们知道 JSON 无法深拷贝循环引用，遇到这种情况会抛出异常，所以我们使用另外的解决方法：</p> <h3 id="使用哈希表"><a href="#使用哈希表" class="header-anchor">#</a> 使用哈希表</h3> <p>解决方案很简单，其实就是循环检测，我们设置一个数组或者哈希表存储已拷贝的对象，当检测到当前对象在哈希表中存在时，即取出来并返回。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token keyword">function</span> <span class="token function">cloneDeep3</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> hash <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isObject</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> source<span class="token punctuation">;</span> 
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hash<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> hash<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 新增代码，查哈希表</span>
      
    <span class="token keyword">var</span> target <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    hash<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 新增代码，哈希表设值</span>
    
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> key <span class="token keyword">in</span> source<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>source<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">cloneDeep3</span><span class="token punctuation">(</span>source<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> hash<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 新增代码，传入哈希表</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> source<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> target<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="数组"><a href="#数组" class="header-anchor">#</a> 数组</h3> <p>在 ES5 中没有 weakMap 这种数据格式，所以在 ES5 中使用数组进行代替。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token keyword">function</span> <span class="token function">cloneDeep3</span><span class="token punctuation">(</span><span class="token parameter">source<span class="token punctuation">,</span> uniqueList</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isObject</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> source<span class="token punctuation">;</span> 
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>uniqueList<span class="token punctuation">)</span> uniqueList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 新增代码，初始化数组</span>
      
    <span class="token keyword">var</span> target <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    
    <span class="token comment">// ============= 新增代码</span>
    <span class="token comment">// 数据已经存在，返回保存的数据</span>
    <span class="token keyword">var</span> uniqueData <span class="token operator">=</span> <span class="token function">find</span><span class="token punctuation">(</span>uniqueList<span class="token punctuation">,</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>uniqueData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> uniqueData<span class="token punctuation">.</span>target<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
        
    <span class="token comment">// 数据不存在，保存源数据，以及对应的引用</span>
    uniqueList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        source<span class="token operator">:</span> source<span class="token punctuation">,</span>
        target<span class="token operator">:</span> target
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// =============</span>

    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> key <span class="token keyword">in</span> source<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>source<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">cloneDeep3</span><span class="token punctuation">(</span>source<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> uniqueList<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 新增代码，传入数组</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> source<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> target<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 新增方法，用于查找</span>
<span class="token keyword">function</span> <span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">arr<span class="token punctuation">,</span> item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>source <span class="token operator">===</span> item<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 用上面测试用例已测试通过</span>
</code></pre></div><p>同时，使用缓存的方式，可以解决引用丢失的问题。</p> <h2 id="拷贝-symbol"><a href="#拷贝-symbol" class="header-anchor">#</a> 拷贝 Symbol</h2> <p>这个时候可能要搞事情了，那我们能不能拷贝 Symol 类型呢？</p> <p>当然可以，不过 <code>Symbol</code> 在 <code>ES6</code> 下才有，我们需要一些方法来检测出 <code>Symble</code> 类型。</p> <p>方法一：<code>Object.getOwnPropertySymbols(...)</code></p> <p>方法二：<code>Reflect.ownKeys(...)</code></p> <p><strong>对于方法一</strong>可以查找一个给定对象的符号属性时返回一个 <code>?symbol</code> 类型的数组。注意，每个初始化的对象都是没有自己的 <code>symbol</code> 属性的，因此这个数组可能为空，除非你已经在对象上设置了 <code>symbol</code> 属性。（来自MDN）</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建新的symbol类型</span>
<span class="token keyword">var</span> b <span class="token operator">=</span> Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 从全局的symbol注册?表设置和取得symbol</span>

obj<span class="token punctuation">[</span>a<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;localSymbol&quot;</span><span class="token punctuation">;</span>
obj<span class="token punctuation">[</span>b<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;globalSymbol&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> objectSymbols <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertySymbols</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>objectSymbols<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>objectSymbols<span class="token punctuation">)</span>         <span class="token comment">// [Symbol(a), Symbol(b)]</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>objectSymbols<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>      <span class="token comment">// Symbol(a)</span>
</code></pre></div><p><strong>对于方法二</strong>返回一个由目标对象<strong>自身</strong>的属性键组成的数组。它的返回值等同于<code>Object.getOwnPropertyNames(target).concat(Object.getOwnPropertySymbols(target))</code>。(来自MDN)</p> <div class="language-js extra-class"><pre class="language-js"><code>Reflect<span class="token punctuation">.</span><span class="token function">ownKeys</span><span class="token punctuation">(</span><span class="token punctuation">{</span>z<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> y<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> x<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [ &quot;z&quot;, &quot;y&quot;, &quot;x&quot; ]</span>
Reflect<span class="token punctuation">.</span><span class="token function">ownKeys</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [&quot;length&quot;]</span>

<span class="token keyword">var</span> sym <span class="token operator">=</span> Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">&quot;comet&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> sym2 <span class="token operator">=</span> Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">&quot;meteor&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">[</span>sym<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;str&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;773&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;0&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
           <span class="token punctuation">[</span>sym2<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;-1&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;8&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;second str&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
Reflect<span class="token punctuation">.</span><span class="token function">ownKeys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// [ &quot;0&quot;, &quot;8&quot;, &quot;773&quot;, &quot;str&quot;, &quot;-1&quot;, &quot;second str&quot;, Symbol(comet), Symbol(meteor) ]</span>
<span class="token comment">// 注意顺序</span>
<span class="token comment">// Indexes in numeric order, </span>
<span class="token comment">// strings in insertion order, </span>
<span class="token comment">// symbols in insertion order</span>
</code></pre></div><h3 id="方法一"><a href="#方法一" class="header-anchor">#</a> 方法一</h3> <p>思路就是先查找有没有 <code>Symbol</code> 属性，如果查找到则先遍历处理 <code>Symbol</code> 情况，然后再处理正常情况，多出来的逻辑就是下面的新增代码。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token keyword">function</span> <span class="token function">cloneDeep4</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> hash <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isObject</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> source<span class="token punctuation">;</span> 
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hash<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> hash<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span> 
      
    <span class="token keyword">let</span> target <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    hash<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// ============= 新增代码</span>
    <span class="token keyword">let</span> symKeys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertySymbols</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 查找</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>symKeys<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 查找成功	</span>
        symKeys<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">symKey</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>source<span class="token punctuation">[</span>symKey<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                target<span class="token punctuation">[</span>symKey<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">cloneDeep4</span><span class="token punctuation">(</span>source<span class="token punctuation">[</span>symKey<span class="token punctuation">]</span><span class="token punctuation">,</span> hash<span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                target<span class="token punctuation">[</span>symKey<span class="token punctuation">]</span> <span class="token operator">=</span> source<span class="token punctuation">[</span>symKey<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>    
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// =============</span>
    
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> source<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>source<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">cloneDeep4</span><span class="token punctuation">(</span>source<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> hash<span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> source<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> target<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="方法二"><a href="#方法二" class="header-anchor">#</a> 方法二</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token keyword">function</span> <span class="token function">cloneDeep4</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> hash <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isObject</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> source<span class="token punctuation">;</span> 
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hash<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> hash<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span> 
      
    <span class="token keyword">let</span> target <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    hash<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
  	Reflect<span class="token punctuation">.</span><span class="token function">ownKeys</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 改动</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>source<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">cloneDeep4</span><span class="token punctuation">(</span>source<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> hash<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> source<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>  
  	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> target<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 测试已通过</span>
</code></pre></div><p>这里使用了 <code>Reflect.ownKeys()</code> 获取所有的键值，同时包括 <code>Symbol</code>，对 source 遍历赋值即可。</p> <p>写到这里已经差不多了，我们再延伸下，对于 <code>target</code> 换一种写法，改动如下。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token keyword">function</span> <span class="token function">cloneDeep4</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> hash <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isObject</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> source<span class="token punctuation">;</span> 
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hash<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> hash<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span> 
      
    <span class="token keyword">let</span> target <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token operator">...</span>source<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span>source <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// 改动 1</span>
    hash<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
  	Reflect<span class="token punctuation">.</span><span class="token function">ownKeys</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 改动 2</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>source<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">cloneDeep4</span><span class="token punctuation">(</span>source<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> hash<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> source<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>  
  	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> target<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 测试已通过</span>
</code></pre></div><p>在改动 1 中，返回一个新数组或者新对象，获取到源对象之后就可以如改动 2 所示传入 target 遍历赋值即可。</p> <p><code>Reflect.ownKeys()</code> 这种方式的问题在于不能深拷贝原型链上的数据，因为返回的是目标对象<strong>自身</strong>的属性键组成的数组。如果想深拷贝原型链上的数据怎么办，那用 <code>for..in</code> 就可以了。</p> <p>我们再介绍下两个知识点，分别是<strong>构造字面量数组时使用展开语法</strong>和<strong>构造字面量对象时使用展开语法</strong>。（以下代码示例来源于 MDN）</p> <h4 id="_1、展开语法之字面量数组"><a href="#_1、展开语法之字面量数组" class="header-anchor">#</a> 1、展开语法之字面量数组</h4> <p>这是 <code>ES2015 （ES6）</code> 才有的语法，可以通过字面量方式, 构造新数组，而不再需要组合使用 <code>push</code>, <code>splice</code>, <code>concat</code> 等方法。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> parts <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'shoulders'</span><span class="token punctuation">,</span> <span class="token string">'knees'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token keyword">var</span> lyrics <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'head'</span><span class="token punctuation">,</span> <span class="token operator">...</span>parts<span class="token punctuation">,</span> <span class="token string">'and'</span><span class="token punctuation">,</span> <span class="token string">'toes'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token comment">// [&quot;head&quot;, &quot;shoulders&quot;, &quot;knees&quot;, &quot;and&quot;, &quot;toes&quot;]</span>
</code></pre></div><p>这里的使用方法和参数列表的展开有点类似。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">myFunction</span><span class="token punctuation">(</span><span class="token parameter">v<span class="token punctuation">,</span> w<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token keyword">var</span> args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token function">myFunction</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>返回的是新数组，对新数组修改之后不会影响到旧数组，类似于 <code>arr.slice()</code>。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> arr2 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>arr<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// like arr.slice()</span>
arr2<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token comment">// arr2 此时变成 [1, 2, 3, 4]</span>
<span class="token comment">// arr 不受影响</span>
</code></pre></div><p>展开语法和 <code>Object.assign()</code> 行为一致, 执行的都是浅拷贝（即只遍历一层）。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>a<span class="token punctuation">]</span><span class="token punctuation">;</span>
b<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
<span class="token comment">// [[], [2], [3]]</span>
</code></pre></div><p>这里 a 是多层数组，b 只拷贝了第一层，对于第二层依旧和 a 持有同一个地址，所以对 b 的修改会影响到 a。</p> <h4 id="_2、展开语法之字面量对象"><a href="#_2、展开语法之字面量对象" class="header-anchor">#</a> 2、展开语法之字面量对象</h4> <p>这是 <code>ES2018</code> 才有的语法，将已有对象的所有<strong>可枚举属性</strong>拷贝到新构造的对象中，类似于 <code>Object.assign()</code> 方法。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> obj1 <span class="token operator">=</span> <span class="token punctuation">{</span> foo<span class="token operator">:</span> <span class="token string">'bar'</span><span class="token punctuation">,</span> x<span class="token operator">:</span> <span class="token number">42</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> obj2 <span class="token operator">=</span> <span class="token punctuation">{</span> foo<span class="token operator">:</span> <span class="token string">'baz'</span><span class="token punctuation">,</span> y<span class="token operator">:</span> <span class="token number">13</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> clonedObj <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>obj1 <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// { foo: &quot;bar&quot;, x: 42 }</span>

<span class="token keyword">var</span> mergedObj <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>obj1<span class="token punctuation">,</span> <span class="token operator">...</span>obj2 <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// { foo: &quot;baz&quot;, x: 42, y: 13 }</span>
</code></pre></div><p><code>Object.assign()</code> 函数会触发 setters，而展开语法不会。有时候不能替换或者模拟 <code>Object.assign()</code> 函数，因为会得到意想不到的结果，如下所示。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> obj1 <span class="token operator">=</span> <span class="token punctuation">{</span> foo<span class="token operator">:</span> <span class="token string">'bar'</span><span class="token punctuation">,</span> x<span class="token operator">:</span> <span class="token number">42</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> obj2 <span class="token operator">=</span> <span class="token punctuation">{</span> foo<span class="token operator">:</span> <span class="token string">'baz'</span><span class="token punctuation">,</span> y<span class="token operator">:</span> <span class="token number">13</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">merge</span> <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token parameter"><span class="token operator">...</span>objects</span> <span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span> <span class="token punctuation">{</span> <span class="token operator">...</span>objects <span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> mergedObj <span class="token operator">=</span> <span class="token function">merge</span> <span class="token punctuation">(</span> obj1<span class="token punctuation">,</span> obj2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// { 0: { foo: 'bar', x: 42 }, 1: { foo: 'baz', y: 13 } }</span>

<span class="token keyword">var</span> mergedObj <span class="token operator">=</span> <span class="token function">merge</span> <span class="token punctuation">(</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> obj1<span class="token punctuation">,</span> obj2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// { 0: {}, 1: { foo: 'bar', x: 42 }, 2: { foo: 'baz', y: 13 } }</span>
</code></pre></div><p>这里实际上是将多个解构变为剩余参数（ <code>rest</code> ），然后再将剩余参数展开为字面量对象.</p> <h2 id="破解递归爆栈"><a href="#破解递归爆栈" class="header-anchor">#</a> 破解递归爆栈</h2> <p>上面四步使用的都是递归方法，但是有一个问题在于会爆栈，错误提示如下。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// RangeError: Maximum call stack size exceeded</span>
</code></pre></div><p>那应该如何解决呢？其实我们使用循环就可以了，代码如下。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">cloneDeep5</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// 栈</span>
    <span class="token keyword">const</span> loopList <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            parent<span class="token operator">:</span> root<span class="token punctuation">,</span>
            key<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
            data<span class="token operator">:</span> x<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span>loopList<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 广度优先</span>
        <span class="token keyword">const</span> node <span class="token operator">=</span> loopList<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> parent <span class="token operator">=</span> node<span class="token punctuation">.</span>parent<span class="token punctuation">;</span>
        <span class="token keyword">const</span> key <span class="token operator">=</span> node<span class="token punctuation">.</span>key<span class="token punctuation">;</span>
        <span class="token keyword">const</span> data <span class="token operator">=</span> node<span class="token punctuation">.</span>data<span class="token punctuation">;</span>

        <span class="token comment">// 初始化赋值目标，key为undefined则拷贝到父元素，否则拷贝到子元素</span>
        <span class="token keyword">let</span> res <span class="token operator">=</span> parent<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> key <span class="token operator">!==</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            res <span class="token operator">=</span> parent<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> k <span class="token keyword">in</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> data<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 下一次循环</span>
                    loopList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                        parent<span class="token operator">:</span> res<span class="token punctuation">,</span>
                        key<span class="token operator">:</span> k<span class="token punctuation">,</span>
                        data<span class="token operator">:</span> data<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    res<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> root<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h1 id="lodash-是如何实现深拷贝的"><a href="#lodash-是如何实现深拷贝的" class="header-anchor">#</a> Lodash 是如何实现深拷贝的</h1> <h2 id="整体流程"><a href="#整体流程" class="header-anchor">#</a> 整体流程</h2> <h3 id="入口"><a href="#入口" class="header-anchor">#</a> 入口</h3> <p>入口文件是 <code>deepClone.js</code> ，直接调用核心文件 <code>baseClonse.js</code> 的方法。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token constant">CLONE_DEEP_FLAG</span> <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">const</span> <span class="token constant">CLONE_SYMBOLS_FLAG</span> <span class="token operator">=</span> <span class="token number">4</span>

<span class="token keyword">function</span> <span class="token function">cloneDeep</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">baseClone</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token constant">CLONE_DEEP_FLAG</span> <span class="token operator">|</span> <span class="token constant">CLONE_SYMBOLS_FLAG</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>第一个参数是需要拷贝的对象，第二个是位掩码（Bitwise），关于位掩码的详细介绍请看下面拓展部分。</p> <h3 id="baseclone-方法"><a href="#baseclone-方法" class="header-anchor">#</a> baseClone 方法</h3> <p>先介绍一下该方法的参数 <code>baseClone(value, bitmask, customizer, key, object, stack)</code></p> <ul><li>value：需要拷贝的对象</li> <li>bitmask：位掩码，其中 1 是深拷贝，2 拷贝原型链上的属性，4 是拷贝 Symbols 属性</li> <li>customizer：定制的 clone 函数</li> <li>key：传入 value 值的key</li> <li>object：传入 value 值的父对象</li> <li>stack：Stack 栈，用来处理循环引用</li></ul> <p>我将分成以下几部分进行讲解，可以选择自己感兴趣的部分阅读。</p> <ul><li>位掩码</li> <li>定制 <code>clone</code> 函数</li> <li>非对象</li> <li>数组 &amp; 正则</li> <li>对象 &amp; 函数</li> <li>循环引用</li> <li>Map &amp; Set</li> <li>Symbol &amp; 原型链</li></ul> <h2 id="baseclone-完整代码"><a href="#baseclone-完整代码" class="header-anchor">#</a> baseClone 完整代码</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token keyword">function</span> <span class="token function">baseClone</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span> bitmask<span class="token punctuation">,</span> customizer<span class="token punctuation">,</span> key<span class="token punctuation">,</span> object<span class="token punctuation">,</span> stack</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> result

    <span class="token comment">// 标志位</span>
    <span class="token keyword">const</span> isDeep <span class="token operator">=</span> bitmask <span class="token operator">&amp;</span> <span class="token constant">CLONE_DEEP_FLAG</span>		<span class="token comment">// 深拷贝，true</span>
    <span class="token keyword">const</span> isFlat <span class="token operator">=</span> bitmask <span class="token operator">&amp;</span> <span class="token constant">CLONE_FLAT_FLAG</span>		<span class="token comment">// 拷贝原型链，false</span>
    <span class="token keyword">const</span> isFull <span class="token operator">=</span> bitmask <span class="token operator">&amp;</span> <span class="token constant">CLONE_SYMBOLS_FLAG</span>	<span class="token comment">// 拷贝 Symbol，true</span>

    <span class="token comment">// 自定义 clone 函数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>customizer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        result <span class="token operator">=</span> object <span class="token operator">?</span> <span class="token function">customizer</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> key<span class="token punctuation">,</span> object<span class="token punctuation">,</span> stack<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">customizer</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> result
    <span class="token punctuation">}</span>

    <span class="token comment">// 非对象  </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isObject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> value
    <span class="token punctuation">}</span>
    
    <span class="token keyword">const</span> isArr <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    <span class="token keyword">const</span> tag <span class="token operator">=</span> <span class="token function">getTag</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isArr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 数组</span>
        result <span class="token operator">=</span> <span class="token function">initCloneArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isDeep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">copyArray</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> result<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 对象</span>
        <span class="token keyword">const</span> isFunc <span class="token operator">=</span> <span class="token keyword">typeof</span> value <span class="token operator">==</span> <span class="token string">'function'</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isBuffer</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">cloneBuffer</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> isDeep<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tag <span class="token operator">==</span> objectTag <span class="token operator">||</span> tag <span class="token operator">==</span> argsTag <span class="token operator">||</span> <span class="token punctuation">(</span>isFunc <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>object<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            result <span class="token operator">=</span> <span class="token punctuation">(</span>isFlat <span class="token operator">||</span> isFunc<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token operator">:</span> <span class="token function">initCloneObject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isDeep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> isFlat
                    <span class="token operator">?</span> <span class="token function">copySymbolsIn</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token function">copyObject</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token function">keysIn</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">)</span>
                	<span class="token operator">:</span> <span class="token function">copySymbols</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isFunc <span class="token operator">||</span> <span class="token operator">!</span>cloneableTags<span class="token punctuation">[</span>tag<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> object <span class="token operator">?</span> value <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            result <span class="token operator">=</span> <span class="token function">initCloneByTag</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> isDeep<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 循环引用</span>
    stack <span class="token operator">||</span> <span class="token punctuation">(</span>stack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Stack</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> stacked <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stacked<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> stacked
    <span class="token punctuation">}</span>
    stack<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> result<span class="token punctuation">)</span>

    <span class="token comment">// Map</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tag <span class="token operator">==</span> mapTag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        value<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">subValue<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            result<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token function">baseClone</span><span class="token punctuation">(</span>subValue<span class="token punctuation">,</span> bitmask<span class="token punctuation">,</span> customizer<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> stack<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> result
    <span class="token punctuation">}</span>

    <span class="token comment">// Set</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tag <span class="token operator">==</span> setTag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        value<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">subValue</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">baseClone</span><span class="token punctuation">(</span>subValue<span class="token punctuation">,</span> bitmask<span class="token punctuation">,</span> customizer<span class="token punctuation">,</span> subValue<span class="token punctuation">,</span> value<span class="token punctuation">,</span> stack<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> result
    <span class="token punctuation">}</span>

    <span class="token comment">// TypedArray</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isTypedArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> result
    <span class="token punctuation">}</span>

    <span class="token comment">// Symbol &amp; 原型链</span>
    <span class="token keyword">const</span> keysFunc <span class="token operator">=</span> isFull
    	<span class="token operator">?</span> <span class="token punctuation">(</span>isFlat <span class="token operator">?</span> getAllKeysIn <span class="token operator">:</span> getAllKeys<span class="token punctuation">)</span>
    	<span class="token operator">:</span> <span class="token punctuation">(</span>isFlat <span class="token operator">?</span> keysIn <span class="token operator">:</span> keys<span class="token punctuation">)</span>

    <span class="token keyword">const</span> props <span class="token operator">=</span> isArr <span class="token operator">?</span> <span class="token keyword">undefined</span> <span class="token operator">:</span> <span class="token function">keysFunc</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    
    <span class="token comment">// 遍历赋值</span>
    <span class="token function">arrayEach</span><span class="token punctuation">(</span>props <span class="token operator">||</span> value<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">subValue<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            key <span class="token operator">=</span> subValue
            subValue <span class="token operator">=</span> value<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
        <span class="token function">assignValue</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token function">baseClone</span><span class="token punctuation">(</span>subValue<span class="token punctuation">,</span> bitmask<span class="token punctuation">,</span> customizer<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> stack<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    
    <span class="token comment">// 返回结果</span>
    <span class="token keyword">return</span> result
<span class="token punctuation">}</span>
</code></pre></div><h2 id="详细功能实现"><a href="#详细功能实现" class="header-anchor">#</a> 详细功能实现</h2> <h3 id="位掩码"><a href="#位掩码" class="header-anchor">#</a> 位掩码</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token comment">// 主线代码</span>
<span class="token keyword">const</span> <span class="token constant">CLONE_DEEP_FLAG</span> <span class="token operator">=</span> <span class="token number">1</span>		<span class="token comment">// 1 即 0001，深拷贝标志位</span>
<span class="token keyword">const</span> <span class="token constant">CLONE_FLAT_FLAG</span> <span class="token operator">=</span> <span class="token number">2</span>		<span class="token comment">// 2 即 0010，拷贝原型链标志位，</span>
<span class="token keyword">const</span> <span class="token constant">CLONE_SYMBOLS_FLAG</span> <span class="token operator">=</span> <span class="token number">4</span>	<span class="token comment">// 4 即 0100，拷贝 Symbols 标志位</span>
</code></pre></div><p>位掩码用于处理同时存在多个布尔选项的情况，其中<strong>掩码中的每个选项的值都等于 2 的幂</strong>。相比直接使用变量来说，优点是可以节省内存（1/32）（来自<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/Bitwise_Operators" target="_blank" rel="noopener noreferrer">MDN<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token comment">// 主线代码</span>
<span class="token comment">// cloneDeep.js 添加标志位，1 | 4 即 0001 | 0100 即 0101 即 5</span>
<span class="token constant">CLONE_DEEP_FLAG</span> <span class="token operator">|</span> <span class="token constant">CLONE_SYMBOLS_FLAG</span>

<span class="token comment">// baseClone.js 取出标志位</span>
<span class="token keyword">let</span> result <span class="token comment">// 初始化返回结果，后续代码需要，和位掩码无关</span>
<span class="token keyword">const</span> isDeep <span class="token operator">=</span> bitmask <span class="token operator">&amp;</span> <span class="token constant">CLONE_DEEP_FLAG</span> 	<span class="token comment">// 5 &amp; 1 即 1 即 true</span>
<span class="token keyword">const</span> isFlat <span class="token operator">=</span> bitmask <span class="token operator">&amp;</span> <span class="token constant">CLONE_FLAT_FLAG</span>	<span class="token comment">// 5 &amp; 2 即 0 即 false</span>
<span class="token keyword">const</span> isFull <span class="token operator">=</span> bitmask <span class="token operator">&amp;</span> <span class="token constant">CLONE_SYMBOLS_FLAG</span> <span class="token comment">// 5 &amp; 4 即 4 即 true</span>
</code></pre></div><p>基本操作如下</p> <ul><li><code>a | b</code>：添加标志位 a 和 b</li> <li><code>mask &amp; b</code>：取出标志位 a</li> <li><code>mask &amp; ~a</code>：清除标志位 a</li> <li><code>mask ^ a</code>：取出与 a 的不同部分</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token keyword">var</span> <span class="token constant">FLAG_A</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 0001</span>
<span class="token keyword">var</span> <span class="token constant">FLAG_B</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token comment">// 0100</span>

<span class="token comment">// 添加标志位 a 和 b =&gt; a | b</span>
<span class="token keyword">var</span> mask <span class="token operator">=</span> <span class="token constant">FLAG_A</span> <span class="token operator">|</span> <span class="token parameter"><span class="token constant">FLAG_B</span></span> <span class="token operator">=&gt;</span> <span class="token number">0101</span> <span class="token operator">=&gt;</span> <span class="token number">5</span>

<span class="token comment">// 取出标志位 a =&gt; mask &amp; a</span>
mask <span class="token operator">&amp;</span> <span class="token parameter"><span class="token constant">FLAG_A</span></span> <span class="token operator">=&gt;</span> <span class="token number">0001</span> <span class="token operator">=&gt;</span> <span class="token number">1</span>
mask <span class="token operator">&amp;</span> <span class="token parameter"><span class="token constant">FLAG_B</span></span> <span class="token operator">=&gt;</span> <span class="token number">0100</span> <span class="token operator">=&gt;</span> <span class="token number">4</span>

<span class="token comment">// 清除标记位 a =&gt; mask &amp; ~a</span>
mask <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token parameter"><span class="token constant">FLAG_A</span></span> <span class="token operator">=&gt;</span> <span class="token number">0100</span> <span class="token operator">=&gt;</span> <span class="token number">4</span>

<span class="token comment">// 取出与 a 的不同部分 =&gt; mask ^ a</span>
mask <span class="token operator">^</span> <span class="token parameter"><span class="token constant">FLAG_A</span></span> <span class="token operator">=&gt;</span> <span class="token number">0100</span> <span class="token operator">=&gt;</span> <span class="token number">4</span>
mask <span class="token operator">^</span> <span class="token parameter"><span class="token constant">FLAG_B</span></span> <span class="token operator">=&gt;</span> <span class="token number">0001</span> <span class="token operator">=&gt;</span> <span class="token number">1</span>
<span class="token constant">FLAG_A</span> <span class="token operator">^</span> <span class="token parameter"><span class="token constant">FLAG_B</span></span> <span class="token operator">=&gt;</span> <span class="token number">0101</span> <span class="token operator">=&gt;</span> <span class="token number">5</span>
</code></pre></div><h3 id="定制-clone-函数"><a href="#定制-clone-函数" class="header-anchor">#</a> 定制 clone 函数</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token comment">// 主线代码</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>customizer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	result <span class="token operator">=</span> object <span class="token operator">?</span> <span class="token function">customizer</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> key<span class="token punctuation">,</span> object<span class="token punctuation">,</span> stack<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">customizer</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> result
<span class="token punctuation">}</span>
</code></pre></div><p>上面代码比较清晰，存在定制 <code>clone</code> 函数时，如果存在 value 值的父对象，就传入 <code>value、key、object、stack</code> 这些值，不存在父对象直接传入 <code>value</code> 执行定制函数。函数返回值 <code>result</code> 不为空则返回执行结果。</p> <p>这部分是为了定制 <code>clone</code> 函数暴露出来的方法。</p> <h3 id="非对象"><a href="#非对象" class="header-anchor">#</a> 非对象</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token comment">// 主线代码</span>
<span class="token comment">//判断要拷贝的值是否是对象，非对象直接返回本来的值</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isObject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> value<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// ../isObject.js</span>
<span class="token keyword">function</span> <span class="token function">isObject</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> type <span class="token operator">=</span> <span class="token keyword">typeof</span> value<span class="token punctuation">;</span>
    <span class="token keyword">return</span> value <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> <span class="token string">'object'</span> <span class="token operator">||</span> type <span class="token operator">=</span><span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这一点的处理基本与上一章我们的深拷贝函数处理一致，区别在于判断对象中多加了一层 function 的判断，用于函数的拷贝。</p> <h3 id="数组-正则"><a href="#数组-正则" class="header-anchor">#</a> 数组 &amp; 正则</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token comment">// 主线代码</span>
<span class="token keyword">const</span> isArr <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
<span class="token keyword">const</span> hasOwnProperty <span class="token operator">=</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>hasOwnProperty

<span class="token keyword">if</span> <span class="token punctuation">(</span>isArr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 数组</span>
    result <span class="token operator">=</span> <span class="token function">initCloneArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isDeep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">copyArray</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> result<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span> <span class="token comment">// 非数组，后面解析</span>
<span class="token punctuation">}</span>

<span class="token comment">// 初始化一个数组</span>
<span class="token keyword">function</span> <span class="token function">initCloneArray</span><span class="token punctuation">(</span><span class="token parameter">array</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  	<span class="token keyword">const</span> <span class="token punctuation">{</span> length <span class="token punctuation">}</span> <span class="token operator">=</span> array
    <span class="token comment">// 构造相同长度的新数组</span>
  	<span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">array<span class="token punctuation">.</span>constructor</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span>

  	<span class="token comment">// 正则 `RegExp#exec` 返回的数组</span>
  	<span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> array<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'string'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> <span class="token string">'index'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   	 	result<span class="token punctuation">.</span>index <span class="token operator">=</span> array<span class="token punctuation">.</span>index
    	result<span class="token punctuation">.</span>input <span class="token operator">=</span> array<span class="token punctuation">.</span>input
  	<span class="token punctuation">}</span>
  	<span class="token keyword">return</span> result
<span class="token punctuation">}</span>
    
<span class="token comment">// ... 未完待续，最后部分有数组遍历赋值 </span>
</code></pre></div><p>传入的对象是数组时，构造一个相同长度的数组 <code>new array.constructor(length)</code>，这里相当于 <code>new Array(length)</code>，因为 <code>array.constructor === Array</code>。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
a<span class="token punctuation">.</span>constructor <span class="token operator">===</span> Array<span class="token punctuation">;</span> <span class="token comment">// true</span>

<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">;</span>
a<span class="token punctuation">.</span>constructor <span class="token operator">===</span> Array <span class="token comment">// true</span>
</code></pre></div><p>如果存在正则 <code>RegExp#exec</code> 返回的数组，拷贝属性 <code>index</code> 和 <code>input</code>。判断逻辑是 1、数组长度大于 0，2、数组第一个元素是字符串类型，3、数组存在 <code>index</code> 属性。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> array<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'string'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> <span class="token string">'index'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    result<span class="token punctuation">.</span>index <span class="token operator">=</span> array<span class="token punctuation">.</span>index
    result<span class="token punctuation">.</span>input <span class="token operator">=</span> array<span class="token punctuation">.</span>input
<span class="token punctuation">}</span>
</code></pre></div><p>其中正则表达式 <code>regexObj.exec(str)</code> 匹配成功时，返回一个数组，并更新正则表达式对象的属性。返回的数组将完全匹配成功的文本作为第一项，将正则括号里匹配成功的作为数组填充到后面。匹配失败时返回 <code>null</code>。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token keyword">var</span> re <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">quick\s(brown).+?(jumps)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">ig</span></span><span class="token punctuation">;</span>
<span class="token keyword">var</span> result <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">'The Quick Brown Fox Jumps Over The Lazy Dog'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// [</span>
<span class="token comment">//	0: &quot;Quick Brown Fox Jumps&quot; 	// 匹配的全部字符串</span>
<span class="token comment">//	1: &quot;Brown&quot;					// 括号中的分组捕获</span>
<span class="token comment">//	2: &quot;Jumps&quot;</span>
<span class="token comment">//	groups: undefined</span>
<span class="token comment">//	index: 4					// 匹配到的字符位于原始字符串的基于0的索引值</span>
<span class="token comment">//	input: &quot;The Quick Brown Fox Jumps Over The Lazy Dog&quot; // 原始字符串</span>
<span class="token comment">//	length: 3</span>
<span class="token comment">// ]</span>
</code></pre></div><p>如果不是深拷贝，传入<code>value</code> 和 <code>result</code>，直接返回浅拷贝后的数组。这里的浅拷贝方式就是循环然后复制。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isDeep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">copyArray</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> result<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 浅拷贝数组</span>
<span class="token keyword">function</span> <span class="token function">copyArray</span><span class="token punctuation">(</span><span class="token parameter">source<span class="token punctuation">,</span> array</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
  <span class="token keyword">const</span> length <span class="token operator">=</span> source<span class="token punctuation">.</span>length
  array <span class="token operator">||</span> <span class="token punctuation">(</span>array <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">++</span>index <span class="token operator">&lt;</span> length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    array<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> source<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> array
<span class="token punctuation">}</span>
</code></pre></div><h3 id="对象-函数"><a href="#对象-函数" class="header-anchor">#</a> 对象 &amp; 函数</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token comment">// 主线代码</span>
<span class="token keyword">const</span> isArr <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
<span class="token keyword">const</span> tag <span class="token operator">=</span> <span class="token function">getTag</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>isArr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span> <span class="token comment">// 数组情况，详见上面解析</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 函数</span>
    <span class="token keyword">const</span> isFunc <span class="token operator">=</span> <span class="token keyword">typeof</span> value <span class="token operator">==</span> <span class="token string">'function'</span>

    <span class="token comment">// 如果是 Buffer 对象，拷贝并返回</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isBuffer</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">cloneBuffer</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> isDeep<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// Object 对象、类数组、或者是函数但没有父对象</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tag <span class="token operator">==</span> objectTag <span class="token operator">||</span> tag <span class="token operator">==</span> argsTag <span class="token operator">||</span> <span class="token punctuation">(</span>isFunc <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>object<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 拷贝原型链或者 value 是函数时，返回 {}，不然初始化对象</span>
        result <span class="token operator">=</span> <span class="token punctuation">(</span>isFlat <span class="token operator">||</span> isFunc<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token operator">:</span> <span class="token function">initCloneObject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isDeep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> isFlat
                <span class="token operator">?</span> <span class="token function">copySymbolsIn</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token function">copyObject</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token function">keysIn</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">)</span>
            	<span class="token operator">:</span> <span class="token function">copySymbols</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 在 cloneableTags 中，只有 error 和 weakmap 返回 false</span>
        <span class="token comment">// 函数或者 error 或者 weakmap 时，</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isFunc <span class="token operator">||</span> <span class="token operator">!</span>cloneableTags<span class="token punctuation">[</span>tag<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 存在父对象返回value，不然返回空对象 {}</span>
            <span class="token keyword">return</span> object <span class="token operator">?</span> value <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 初始化非常规类型</span>
        result <span class="token operator">=</span> <span class="token function">initCloneByTag</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> isDeep<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过上面代码可以发现，函数、<code>error</code> 和 <code>weakmap</code> 时返回空对象 {}，并不会真正拷贝函数。</p> <p><code>value</code> 类型是 <code>Object</code> 对象和类数组时，调用 <code>initCloneObject</code> 初始化对象，最终调用 <code>Object.create</code> 生成新对象。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token keyword">function</span> <span class="token function">initCloneObject</span><span class="token punctuation">(</span><span class="token parameter">object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 构造函数并且自己不在自己的原型链上</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> object<span class="token punctuation">.</span>constructor <span class="token operator">==</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isPrototype</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token operator">?</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">getPrototypeOf</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">)</span>
    	<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 本质上实现了一个instanceof，用来测试自己是否在自己的原型链上</span>
<span class="token keyword">function</span> <span class="token function">isPrototype</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> Ctor <span class="token operator">=</span> value <span class="token operator">&amp;&amp;</span> value<span class="token punctuation">.</span>constructor
    <span class="token comment">// 寻找对应原型</span>
    <span class="token keyword">const</span> proto <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> Ctor <span class="token operator">==</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">Ctor</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype
    <span class="token keyword">return</span> value <span class="token operator">===</span> proto
<span class="token punctuation">}</span>
</code></pre></div><p>其中 <code>Object</code> 的构造函数是一个函数对象。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">typeof</span> obj<span class="token punctuation">.</span>constructor<span class="token punctuation">;</span> 
<span class="token comment">// 'function'</span>

<span class="token keyword">var</span> obj2 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">typeof</span> obj2<span class="token punctuation">.</span>constructor<span class="token punctuation">;</span>
<span class="token comment">// 'function'</span>
</code></pre></div><p>对于非常规类型对象，通过各自类型分别进行初始化。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token keyword">function</span> <span class="token function">initCloneByTag</span><span class="token punctuation">(</span><span class="token parameter">object<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> isDeep</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> Ctor <span class="token operator">=</span> object<span class="token punctuation">.</span>constructor
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> arrayBufferTag<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token function">cloneArrayBuffer</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span>

        <span class="token keyword">case</span> boolTag<span class="token operator">:</span> <span class="token comment">// 布尔与时间类型</span>
        <span class="token keyword">case</span> dateTag<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Ctor</span><span class="token punctuation">(</span><span class="token operator">+</span>object<span class="token punctuation">)</span> <span class="token comment">// + 转换为数字</span>

        <span class="token keyword">case</span> dataViewTag<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token function">cloneDataView</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> isDeep<span class="token punctuation">)</span>

        <span class="token keyword">case</span> float32Tag<span class="token operator">:</span> <span class="token keyword">case</span> float64Tag<span class="token operator">:</span>
        <span class="token keyword">case</span> int8Tag<span class="token operator">:</span> <span class="token keyword">case</span> int16Tag<span class="token operator">:</span> <span class="token keyword">case</span> int32Tag<span class="token operator">:</span>
        <span class="token keyword">case</span> uint8Tag<span class="token operator">:</span> <span class="token keyword">case</span> uint8ClampedTag<span class="token operator">:</span> <span class="token keyword">case</span> uint16Tag<span class="token operator">:</span> <span class="token keyword">case</span> uint32Tag<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token function">cloneTypedArray</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> isDeep<span class="token punctuation">)</span>

        <span class="token keyword">case</span> mapTag<span class="token operator">:</span> <span class="token comment">// Map 类型</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Ctor</span>

        <span class="token keyword">case</span> numberTag<span class="token operator">:</span> <span class="token comment">// 数字和字符串类型</span>
        <span class="token keyword">case</span> stringTag<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Ctor</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span>

        <span class="token keyword">case</span> regexpTag<span class="token operator">:</span> <span class="token comment">// 正则</span>
            <span class="token keyword">return</span> <span class="token function">cloneRegExp</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span>

        <span class="token keyword">case</span> setTag<span class="token operator">:</span> <span class="token comment">// Set 类型</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Ctor</span>

        <span class="token keyword">case</span> symbolTag<span class="token operator">:</span> <span class="token comment">// Symbol 类型</span>
            <span class="token keyword">return</span> <span class="token function">cloneSymbol</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>拷贝正则类型：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token comment">// \w 用于匹配字母，数字或下划线字符，相当于[A-Za-z0-9_]</span>
<span class="token keyword">const</span> reFlags <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\w*$</span><span class="token regex-delimiter">/</span></span>
<span class="token keyword">function</span> <span class="token function">cloneRegExp</span><span class="token punctuation">(</span><span class="token parameter">regexp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 返回当前匹配的文本</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">regexp<span class="token punctuation">.</span>constructor</span><span class="token punctuation">(</span>regexp<span class="token punctuation">.</span>source<span class="token punctuation">,</span> reFlags<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>regexp<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 下一次匹配的起始索引</span>
    result<span class="token punctuation">.</span>lastIndex <span class="token operator">=</span> regexp<span class="token punctuation">.</span>lastIndex
    <span class="token keyword">return</span> result
<span class="token punctuation">}</span>
</code></pre></div><p>初始化 <code>Symbol</code> 类型</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token keyword">const</span> symbolValueOf <span class="token operator">=</span> <span class="token class-name">Symbol</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>valueOf
<span class="token keyword">function</span> <span class="token function">cloneSymbol</span><span class="token punctuation">(</span><span class="token parameter">symbol</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">Object</span><span class="token punctuation">(</span><span class="token function">symbolValueOf</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>symbol<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="循环引用-2"><a href="#循环引用-2" class="header-anchor">#</a> 循环引用</h3> <p>构造了一个栈用来解决循环引用的问题。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token comment">// 主线代码</span>
stack <span class="token operator">||</span> <span class="token punctuation">(</span>stack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Stack</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> stacked <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
<span class="token comment">// 已存在</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>stacked<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> stacked
<span class="token punctuation">}</span>
stack<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> result<span class="token punctuation">)</span>
</code></pre></div><p>如果当前需要拷贝的值已存在于栈中，说明有环，直接返回即可。栈中没有该值时保存到栈中，传入 <code>value</code> 和 <code>result</code>。这里的 <code>result</code> 是一个对象引用，后续对 <code>result</code> 的修改也会反应到栈中。</p> <h3 id="map-set"><a href="#map-set" class="header-anchor">#</a> Map &amp; Set</h3> <p><code>value</code> 值是 <code>Map</code> 类型时，遍历 <code>value</code> 并递归其 <code>subValue</code>，遍历完成返回 <code>result</code> 结果。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token comment">// 主线代码</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>tag <span class="token operator">==</span> mapTag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    value<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">subValue<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        result<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token function">baseClone</span><span class="token punctuation">(</span>subValue<span class="token punctuation">,</span> bitmask<span class="token punctuation">,</span> customizer<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> stack<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> result
<span class="token punctuation">}</span>
</code></pre></div><p><code>value</code> 值是 <code>Set</code> 类型时，遍历 <code>value</code> 并递归其 <code>subValue</code>，遍历完成返回 <code>result</code> 结果。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token comment">// 主线代码</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>tag <span class="token operator">==</span> setTag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    value<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">subValue</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">baseClone</span><span class="token punctuation">(</span>subValue<span class="token punctuation">,</span> bitmask<span class="token punctuation">,</span> customizer<span class="token punctuation">,</span> subValue<span class="token punctuation">,</span> value<span class="token punctuation">,</span> stack<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> result
<span class="token punctuation">}</span>
</code></pre></div><p>上面的区别在于添加元素的 API 不同，即 <code>Map.set</code> 和 <code>Set.add</code>。</p> <h3 id="symbol-原型链"><a href="#symbol-原型链" class="header-anchor">#</a> Symbol &amp; 原型链</h3> <p>这里我们介绍下 <code>Symbol</code> 和 原型链属性的拷贝，通过标志位 <code>isFull</code> 和 <code>isFlat</code> 来控制是否拷贝。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token comment">// 主线代码</span>
<span class="token comment">// 类型化数组对象</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isTypedArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> result
<span class="token punctuation">}</span>

<span class="token keyword">const</span> keysFunc <span class="token operator">=</span> isFull <span class="token comment">// 拷贝 Symbol 标志位</span>
	<span class="token operator">?</span> <span class="token punctuation">(</span>isFlat 			<span class="token comment">// 拷贝原型链属性标志位</span>
       <span class="token operator">?</span> getAllKeysIn 	<span class="token comment">// 包含自身和原型链上可枚举属性名以及 Symbol</span>
       <span class="token operator">:</span> getAllKeys<span class="token punctuation">)</span>	<span class="token comment">// 仅包含自身可枚举属性名以及 Symbol</span>
	<span class="token operator">:</span> <span class="token punctuation">(</span>isFlat 
       <span class="token operator">?</span> keysIn 		<span class="token comment">// 包含自身和原型链上可枚举属性名的数组</span>
       <span class="token operator">:</span> keys<span class="token punctuation">)</span>			<span class="token comment">// 仅包含自身可枚举属性名的数组</span>

<span class="token keyword">const</span> props <span class="token operator">=</span> isArr <span class="token operator">?</span> <span class="token keyword">undefined</span> <span class="token operator">:</span> <span class="token function">keysFunc</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
<span class="token function">arrayEach</span><span class="token punctuation">(</span>props <span class="token operator">||</span> value<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">subValue<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        key <span class="token operator">=</span> subValue
        subValue <span class="token operator">=</span> value<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 递归拷贝（易受调用堆栈限制）</span>
    <span class="token function">assignValue</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token function">baseClone</span><span class="token punctuation">(</span>subValue<span class="token punctuation">,</span> bitmask<span class="token punctuation">,</span> customizer<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> stack<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">return</span> result
</code></pre></div><p>我们先来看下怎么获取自身、原型链、Symbol 这几种属性名组成的数组 <code>keys</code>。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token comment">// 创建一个包含自身和原型链上可枚举属性名以及 Symbol 的数组</span>
<span class="token comment">// 使用 for...in 遍历</span>
<span class="token keyword">function</span> <span class="token function">getAllKeysIn</span><span class="token punctuation">(</span><span class="token parameter">object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">keysIn</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token function">getSymbolsIn</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result
<span class="token punctuation">}</span>

<span class="token comment">// 创建一个仅包含自身可枚举属性名以及 Symbol 的数组</span>
<span class="token comment">// 非 ArrayLike 数组使用 Object.keys</span>
<span class="token keyword">function</span> <span class="token function">getAllKeys</span><span class="token punctuation">(</span><span class="token parameter">object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">keys</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token function">getSymbols</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result
<span class="token punctuation">}</span>
</code></pre></div><p>上面通过 <code>keysIn</code> 和 <code>keys</code> 获取常规可枚举属性，通过 <code>getSymbolsIn</code> 和 <code>getSymbols</code> 获取 <code>Symbol</code> 可枚举属性。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token comment">// 创建一个包含自身和原型链上可枚举属性名的数组</span>
<span class="token comment">// 使用 for...in 遍历</span>
<span class="token keyword">function</span> <span class="token function">keysIn</span><span class="token punctuation">(</span><span class="token parameter">object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result
<span class="token punctuation">}</span>

<span class="token comment">// 创建一个仅包含自身可枚举属性名的数组</span>
<span class="token comment">// 非 ArrayLike 数组使用 Object.keys</span>
<span class="token keyword">function</span> <span class="token function">keys</span><span class="token punctuation">(</span><span class="token parameter">object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">isArrayLike</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span>
        <span class="token operator">?</span> <span class="token function">arrayLikeKeys</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span>
    	<span class="token operator">:</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token function">Object</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 测试代码</span>
<span class="token keyword">function</span> <span class="token function">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">1</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>b <span class="token operator">=</span> <span class="token number">2</span>
<span class="token punctuation">}</span>
<span class="token class-name">Foo</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>c <span class="token operator">=</span> <span class="token number">3</span>

<span class="token function">keysIn</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Foo</span><span class="token punctuation">)</span>
<span class="token comment">// ['a', 'b', 'c'] (迭代顺序无法保证)</span>
     
<span class="token function">keys</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Foo</span><span class="token punctuation">)</span>
<span class="token comment">// ['a', 'b'] (迭代顺序无法保证)</span>
</code></pre></div><p>常规属性遍历原型链用的是 <code>for.. in</code>，那么 <code>Symbol</code> 是如何遍历原型链的呢，这里通过循环以及使用 <code>Object.getPrototypeOf</code> 获取原型链上的 <code>Symbol</code>。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token comment">// 创建一个包含自身和原型链上可枚举 Symbol 的数组</span>
<span class="token comment">// 通过循环和使用 Object.getPrototypeOf 获取原型链上的 Symbol</span>
<span class="token keyword">function</span> <span class="token function">getSymbolsIn</span> <span class="token punctuation">(</span><span class="token parameter">object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>object<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 循环</span>
        result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token function">getSymbols</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">)</span>
        object <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getPrototypeOf</span><span class="token punctuation">(</span><span class="token function">Object</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result
<span class="token punctuation">}</span>

<span class="token comment">// 创建一个仅包含自身可枚举 Symbol 的数组</span>
<span class="token comment">// 通过 Object.getOwnPropertySymbols 获取 Symbol 属性</span>
<span class="token keyword">const</span> nativeGetSymbols <span class="token operator">=</span> Object<span class="token punctuation">.</span>getOwnPropertySymbols
<span class="token keyword">const</span> propertyIsEnumerable <span class="token operator">=</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>propertyIsEnumerable

<span class="token keyword">function</span> <span class="token function">getSymbols</span> <span class="token punctuation">(</span><span class="token parameter">object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>object <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 判空</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    object <span class="token operator">=</span> <span class="token function">Object</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">nativeGetSymbols</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">symbol</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">propertyIsEnumerable</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> symbol<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们回到主线代码，获取到 <code>keys</code> 组成的 <code>props</code> 数组之后，遍历并递归。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token comment">// 主线代码</span>
<span class="token keyword">const</span> props <span class="token operator">=</span> isArr <span class="token operator">?</span> <span class="token keyword">undefined</span> <span class="token operator">:</span> <span class="token function">keysFunc</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
<span class="token function">arrayEach</span><span class="token punctuation">(</span>props <span class="token operator">||</span> value<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">subValue<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// props 时替换 key 和 subValue，因为 props 里面的 subValue 只是 value 的 key</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        key <span class="token operator">=</span> subValue
        subValue <span class="token operator">=</span> value<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 递归拷贝（易受调用堆栈限制）</span>
    <span class="token function">assignValue</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token function">baseClone</span><span class="token punctuation">(</span>subValue<span class="token punctuation">,</span> bitmask<span class="token punctuation">,</span> customizer<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> stack<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 返回结果，主线结束</span>
<span class="token keyword">return</span> result
</code></pre></div><p>我们看下 <code>arrayEach</code> 的实现，主要实现了一个遍历，并在 <code>iteratee</code> 返回为 false 时退出。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token comment">// 迭代数组</span>
<span class="token comment">// iteratee 是每次迭代调用的函数</span>
<span class="token keyword">function</span> <span class="token function">arrayEach</span><span class="token punctuation">(</span><span class="token parameter">array<span class="token punctuation">,</span> iteratee</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
    <span class="token keyword">const</span> length <span class="token operator">=</span> array<span class="token punctuation">.</span>length

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">++</span>index <span class="token operator">&lt;</span> length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">iteratee</span><span class="token punctuation">(</span>array<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">,</span> index<span class="token punctuation">,</span> array<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">break</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> array
<span class="token punctuation">}</span>
</code></pre></div><p>我们看下 <code>assignValue</code> 的实现，在值不相等情况下，将 value 分配给 <code>object[key]</code>。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 木易杨</span>
<span class="token keyword">const</span> hasOwnProperty <span class="token operator">=</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>hasOwnProperty

<span class="token comment">// 如果现有值不相等，则将 value 分配给 object[key]。</span>
<span class="token keyword">function</span> <span class="token function">assignValue</span><span class="token punctuation">(</span><span class="token parameter">object<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> objValue <span class="token operator">=</span> object<span class="token punctuation">[</span>key<span class="token punctuation">]</span>

    <span class="token comment">// 不相等</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token punctuation">(</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">eq</span><span class="token punctuation">(</span>objValue<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 值可用</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">!==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">/</span> value<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">/</span> objValue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">baseAssignValue</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token comment">// 值未定义而且键 key 不在对象中    </span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> object<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">baseAssignValue</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 赋值基本实现，其中没有值检查。</span>
<span class="token keyword">function</span> <span class="token function">baseAssignValue</span><span class="token punctuation">(</span><span class="token parameter">object<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token string">'__proto__'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
            <span class="token string">'configurable'</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token string">'enumerable'</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token string">'value'</span><span class="token operator">:</span> value<span class="token punctuation">,</span>
            <span class="token string">'writable'</span><span class="token operator">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        object<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 比较两个值是否相等</span>
<span class="token comment">// (value !== value &amp;&amp; other !== other) 是为了判断 NaN</span>
<span class="token keyword">function</span> <span class="token function">eq</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span> other</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> value <span class="token operator">===</span> other <span class="token operator">||</span> <span class="token punctuation">(</span>value <span class="token operator">!==</span> value <span class="token operator">&amp;&amp;</span> other <span class="token operator">!==</span> other<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/frontend-knowledge/JavaScript/木易杨前端进阶/作用域闭包.html" class="prev">
        作用域闭包.md
      </a></span> <span class="next"><a href="/frontend-knowledge/JavaScript/木易杨前端进阶/调用堆栈.html">
        调用堆栈.md
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/frontend-knowledge/assets/js/app.1cec9800.js" defer></script><script src="/frontend-knowledge/assets/js/2.62f2d1a2.js" defer></script><script src="/frontend-knowledge/assets/js/87.140cbd00.js" defer></script>
  </body>
</html>
